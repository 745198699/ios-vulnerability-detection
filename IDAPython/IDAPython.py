from idaapi import *
import re
'''

'''
msg_send_dict = dict()  #~msg_send call
BL_dict = dict() #~no paramters call, no class and selector
regs = dict()  #store register value in this function

def parse_MOV(addr):
	des = idc.GetOpnd(addr, 0)
	src = idc.GetOpnd(addr, 1)
	#～change W to X , ignore W
	if des.startswith('W'):
		des = 'X'+des[1:]
				
	if src.startswith('#'):   # MOV X0 #0Xffff
		regs[des]=src[1:]
	else:
		if src in regs:
			regs[des] = regs[src]
		elif des in regs:
			regs[des] = 'Unknown'

def parse_LDR(addr):
	des = idc.GetOpnd(addr, 0)
	#～change W to X , ignore W
	if des.startswith('W'):
		des = 'X'+des[1:]
		
	asm = idc.GetDisasm(addr)
	
	pat = re.compile(r'.+"(.+)"')   #~LDR X1, =sel_defaultManager; "defaultManager"  ""indicate the value
	pat1 = re.compile(r'.+#classRef_(.+)@PAGEOFF]')  #~LDR  X0, [X23,#classRef_NSNumber@PAGEOFF]  X0 is NSNumber
	pat2 = re.compile(r'.+\[(.+)\]')   #~  LDR X3, [X8]   similar with MOV
	pat3 = re.compile(r'.+=_OBJC_CLASS_\$_(.+)')  #~LDR  X0, =_OBJC_CLASS_$_NSMutableURLRequest
	pat4 = re.compile(r'.+=(.+)')   #~LDR  X8, =_kCFStreamSSLAllowsAnyRoot
	
	m = pat.match(asm)
	m1 = pat1.match(asm)
	m2 = pat2.match(asm)
	m3 = pat3.match(asm)
	m4 = pat4.match(asm)
	
	if m:
		regs[des] = m.group(1)
	elif m1:
		regs[des] = m1.group(1)
	elif m2:
		src = m2.group(1)
		if src in regs:
			regs[des]=regs[src]
		else:
			regs[des] = 'Unknown'
	elif m3:
		regs[des] = m3.group(1)
	elif m4:
		regs[des] = m4.group(1)
	else:
		regs[des] = 'Unknown'


def parseB(func_name, addr):
	asm = idc.GetDisasm(addr)
	print asm
	lable = idc.GetOpnd(addr,0)
	if lable =='_objc_msgSend' or lable =="_objc_msgSendSuper2" or lable =="_objc_msgSendSuper2_stret" or lable =="_objc_msgSend_stret":
		if func_name not in msg_send_dict:
			listTmp = []
			listTmp.append(dict(regs))
			msg_send_dict[func_name] = listTmp
		else:
			msg_send_dict[func_name].append(dict(regs))
	else:
		if lable in BL_dict:
			if func_name not in BL_dict[lable]:
				BL_dict[lable].append(func_name)
		else:
			BL_dict[lable]=[func_name]


def getX0FromFuncName(func_name):
	pat = re.compile(r".+\[(\S+).+")
	m = pat.match(func_name)
	if m:
		return m.group(1)
	else:
		return 'Unknown'


def analysis_Xt(addr, xt, start_addr):
	
	if idc.GetMnem(addr) == 'LDR':
		return parse_LDR(addr)


def main():
	

	
	for func in Functions():
		
		if idc.SegName(func) == '__stubs':
			continue
			
		func_name = idc.GetFunctionName(func)
		
		print 'start analyse [ ',func_name,' ]'
		
		regs={}
		regs['X0'] = getX0FromFuncName(func_name)
		regs['X1'] = 'Unknown'
		if func_name != '-[MyCry md5:]':
			continue
		
		
		for addr in FuncItems(func):
			
			if idc.GetMnem(addr) == 'MOV':
				parse_MOV(addr)		
			elif idc.GetMnem(addr) == 'LDR':
				parse_LDR(addr)		
			elif idc.GetMnem(addr) == 'B' or idc.GetMnem(addr)=='BL' or idc.GetMnem(addr)=='BX' or idc.GetMnem(addr)=='BLX':
				parseB(func_name, addr)
				'''print idc.GetDisasm(addr)
				lable = idc.GetOpnd(addr, 0)
				if lable in BL_dict:
					if func_name not in BL_dict[lable]:
						BL_dict[lable].append(func_name)
				else:
					BL_dict[lable] = [func_name]
				'''		
			
			# _objc_msgSend, _objc_msgSend_Super, _objc_msgSend_stret
			#if idc.GetOpnd(addr, 0) == '_objc_msgSend':
			#	msg_send_dict[addr] = [func_name, regs['X0'], regs['X1']]
				
	'''
	for key in BL_dict.keys():
		for me in BL_dict[key]:
			print key,':',me
	'''
	for func_name in msg_send_dict.keys():
		print 'fun_name',func_name
		for it in msg_send_dict[func_name]:
			print '-------------------------------'
			for reg in it.keys():
				print func_name,'->',reg,':',it[reg]
	
	
if __name__ == '__main__':
	main()	
			
			