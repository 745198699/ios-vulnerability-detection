package com.bupt.ios.analyzer;

import java.util.ArrayList;
import java.util.List;
import java.util.Map;
import java.util.Map.Entry;

import com.bupt.ios.commonData.CommonData;
import com.bupt.ios.commonData.IdaResultSet;
import com.bupt.ios.rule.Function;
import com.bupt.ios.rule.SecRule;


/**
 * 
 * @author yujianbo
 * 解析匹配第一类规则，匹配上则表示存在漏洞或缺陷，存入report库中
 */
public class RuleTypeOneAnalyzer {
	
	
	public static void doAnalyse(){
		//加载读取rulePool1中的规则
		for(SecRule secRule:CommonData.getRulePool1()){
			boolean isMatch = false;
			List<Function> content = secRule.getContent();
			for(Function func:content){
				searchInIdaResultSet(func);
			}
		}
	}
	
	/**
	 * 
	 * @param func 传入的Function规则信息
	 * @return 是否匹配上
	 */
	private static boolean searchInIdaResultSet(Function func){
		boolean isMatch = false;
		boolean funType = func.getFuncType();
		String classNString = func.getClassName();
		String funcName = func.getFunctionName();
		Map<String, String> paras = func.getParameters();
		
		//all rules need to match MSG; if function's ClassName is null and FunctionName is NOT null, and have NO parameters, 
		//need to match BL
		
		//search in msg
		List<String> tempResult = new ArrayList<String>();
		for(Entry<String, List<Map<String, String>>> msgEntry : IdaResultSet.getMSG().entrySet()){
			List<Map<String, String>> msgList = msgEntry.getValue();
			for(Map<String, String>msg : msgList){
				if(cmpTwoMaps(paras, msg)){	//if paras in rule = msg in resultSet
					tempResult.add(msgEntry.getKey());
					isMatch=true;
				}
			}
		}
		
		//search in BL
		
		
		//load BL and Msg from IdaResultSet
//		Map<String, List<String>> BL = IdaResultSet.getBL();
//		Map<String, List<Map<String, String>>> MSG = IdaResultSet.getMSG();
		
		
		return isMatch&funType;
		
	}
	
	/**
	 * 
	 * @param paras 规则中的参数信息
	 * @param msg 从ida获取结果的msg_send参数
	 * @return 能否匹配上
	 */
	private static boolean cmpTwoMaps(Map<String, String> paras, Map<String, String> msg){
		for(String reg : paras.keySet()){
			if(!msg.containsKey(reg))
				return false;
			if(!paras.get(reg).equals(msg.get(reg)))
				return false;
		}
		
		return true;
	}

	public static void main(String[] args) {
		// TODO Auto-generated method stub

	}

}
